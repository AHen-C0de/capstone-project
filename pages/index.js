import styled from "styled-components";
import { useState } from "react";
import Link from "next/link";
import Head from "next/head";
import Image from "next/image";

import Header from "../components/Header";
import NavigationBar from "../components/NavigationBar/NavigationBar";
import ContentWrapper from "../components/ContentWrapper";
import ListContainer from "../components/ListContainer";
import ListEmptyMessage from "../components/ListEmptyMessage";
import ShoppingList from "../components/ShoppingList/ShoppingList";
import IconPlusTextButton from "../components/buttons/IconPlusTextButton";
import searchIcon from "/public/assets/icons/search.svg";
import { getAllShoppingItems } from "../services/shoppingItemService";

export async function getServerSideProps() {
  const shoppingItems = await getAllShoppingItems();
  return {
    props: { shoppingItems: shoppingItems },
  };
}

export default function Home({ shoppingItems }) {
  const [listItems, setListItems] = useState(shoppingItems);
  const isEmpty = listItems.length === 0;

  async function toggleItemChecked(id, checkedStatus) {
    const toggeledCheckStatus = { checked: !checkedStatus };

    const response = await fetch("/api/shoppingItems", {
      method: "PATCH",
      body: JSON.stringify({ id: id, data: toggeledCheckStatus }),
    });
    const fetchedData = await response.json();
    const updatedCheckedStatus = fetchedData.updatedShoppingItem.checked;

    setListItems((previousItems) =>
      previousItems.map((item) =>
        item.id === id ? { ...item, checked: updatedCheckedStatus } : item
      )
    );
  }

  return (
    <>
      <Head>
        <title>MyShoppingManager</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <Header>MyShoppingManager</Header>
      <main>
        <ContentWrapper>
          <ListContainer>
            {isEmpty ? (
              <ListEmptyMessage>Leer...</ListEmptyMessage>
            ) : (
              <>
                <ShoppingList
                  listItems={listItems.filter(
                    (shoppingItem) => !shoppingItem.checked
                  )}
                  onToggleItemChecked={toggleItemChecked}
                />
                <StyledText>Fertig:</StyledText>
                <Line />
                <ShoppingList
                  listItems={listItems.filter(
                    (shoppingItem) => shoppingItem.checked
                  )}
                  onToggleItemChecked={toggleItemChecked}
                />
              </>
            )}
          </ListContainer>
          <Link href={"/categories"} passHref>
            <StyledLink>
              <IconPlusTextButton
                padding="0.3rem 0.9rem 0.3rem 0.7rem"
                gap="0.5rem"
                left="0.3rem"
                margin="1.2rem 0 0 0"
              >
                <Image src={searchIcon} alt="Lupe Icon" />
                <p>Suche Kategorie</p>
              </IconPlusTextButton>
            </StyledLink>
          </Link>
        </ContentWrapper>
      </main>
      <NavigationBar />
    </>
  );
}

const StyledText = styled.span`
  font-family: "Lily Script One";
  color: var(--background-secondary);
  font-size: 1.6rem;
  position: relative;
  left: 1rem;
`;

const Line = styled.div`
  width: 70%;
  height: 0.1rem;
  border-radius: 1rem;
  background-color: var(--background-secondary);
  margin: 0.2rem 0 1rem 0;
`;

const StyledLink = styled.a`
  align-self: flex-start;
  text-decoration: none;
`;
